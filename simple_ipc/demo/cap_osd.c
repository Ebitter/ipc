#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <stdint.h>
//#include "fcap_api.h"
#include "vcap_osd.h"           //for 8181

fiosd_char_t tcf;
int video_fd[8] = { 0 };

uint8_t space[36] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

uint8_t c1[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x01, 0xf0, 0x03, 0xc0, 0x06, 0xf0, 0x03, 0xf0, 0x06,
0xf0, 0x01, 0xb0,
    0x03, 0xf0, 0x00, 0x60, 0x00, 0x70, 0x00, 0x60, 0x00, 0xc0, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

uint8_t c2[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0xd8, 0x00, 0xd8, 0x00, 0xf8,
0x00, 0x00, 0x00,
    0xe0, 0x00, 0x60, 0x00, 0xe0, 0x00, 0x60, 0x00, 0xe0, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

uint8_t c3[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x01, 0xf0, 0x00, 0xd0, 0x01, 0xb0, 0x01, 0xf0, 0x01,
0xf0, 0x01, 0xf0,
    0x03, 0x30, 0x03, 0x00, 0x06, 0x60, 0x0c, 0xc0, 0x01, 0x80, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

uint8_t c4[36] =
    { 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x80, 0x00, 0x80, 0x00, 0x78, 0x00, 0xf8, 0x00, 0xf0,
0x00, 0x30, 0x00,
    0xf0, 0x00, 0xc0, 0x00, 0xf0, 0x00, 0xd8, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    //smile diagram
uint8_t c5[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7b, 0xc0, 0x4a, 0x40, 0x7b, 0xc0, 0x00, 0x00, 0x04,
0x00, 0x04, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x60, 0x40, 0x60, 0xc0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

        //font 1-1/6(up part)
uint8_t c6[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x06, 0x00, 0x00,
0x00, 0x00, 0x00,
    0x3f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf0, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00,
        0x03, 0xf0,
};

        //font 1-2/6(up part)
uint8_t c7[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x07, 0xf0, 0xff, 0x00, 0x06, 0x00, 0x06,
0x00, 0x06, 0x00,
    0xff, 0xf0, 0x06, 0x00, 0x06, 0x00, 0xff, 0xf0, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00,
        0xff, 0xf0,
};

    //font 1-3/6(up part)
uint8_t c8[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x01, 0xc0,
    0xff, 0xe0, 0x00, 0x00, 0x04, 0x00, 0xfe, 0x00, 0x0e, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00,
        0xfc, 0x00,
};

    //font 1-4/6(down part)
uint8_t c9[36] =
    { 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0xf0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x07, 0xf0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    // font 1-5/6(down part)
uint8_t c10[36] =
    { 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0xff, 0xf0, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06,
0x00, 0xff, 0xf0,
    0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    //font 1-6/6(down part)
uint8_t c11[36] =
    { 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0xfc, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07,
0x00, 0xff, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    // font 2 1/6(up part)
uint8_t c12[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0xf0, 0x00, 0xc0, 0x00, 0xc0, 0x00,
0xf0, 0x00, 0xc0,
    0x00, 0xc0, 0x00, 0xf0, 0x00, 0xc0, 0x00, 0x00, 0x3f, 0xf0, 0x00, 0x00, 0x00, 0x80, 0x00, 0xf0,
        0x00, 0xc0,
};

    // font 2 2/6(up part)
uint8_t c13[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xff,
0xf0, 0x00, 0x00,
    0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf0,
        0x03, 0x00,
};

    // font 2 3/6(down part)
uint8_t c14[36] =
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0xfc, 0x00, 0x18, 0x00, 0x18, 0x00, 0xf8,
0x00, 0x18, 0x00,
    0x18, 0x00, 0xf8, 0x00, 0x18, 0x40, 0x00, 0xe0, 0xff, 0xf0, 0x00, 0x00, 0x04, 0x00, 0xfe, 0x00,
        0x0c, 0x00,
};

    // font 2 4/6(down part)
uint8_t c15[36] =
    { 0x00, 0xc0, 0x00, 0xf0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xf0, 0x00, 0xc0, 0x00,
0x00, 0x0f, 0xf0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    // font 2 5/6(down part)
uint8_t c16[36] =
    { 0x03, 0x00, 0xff, 0xf0, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0xff, 0xf0, 0x03, 0x00, 0x03,
0x00, 0xff, 0xf0,
    0x03, 0x00, 0x03, 0x00, 0x03, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

    // font 2 6/6(down part)
uint8_t c17[36] =
    { 0x0c, 0x00, 0xfc, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0xfc, 0x00, 0x08, 0x00, 0x03,
0x00, 0xff, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,
};

void initial_font(int channel)
{
    fiosd_char_t ch;
    //fiosd_charmap_t pr;
    int ret;
    char tmp;
    //int i;

    tmp = 'A';                  //take off 'A'
    ret = ioctl(video_fd[channel], FIOSDS_RMCHAR, &tmp);

    ch.font = 'A';
    memcpy((void *)ch.fbitmap, (void *)space, sizeof(uint8_t) * 36);
    ioctl(video_fd[channel], FIOSDS_CHAR, &ch);
}

void listitem_1()
{
    printf("<<Input OSD function test>>\n");
    printf("1. Window 1-8 Encode OSD String On\n");
    printf("2. Window 1-8 Encode OSD String Off\n");
    printf("3. Window 1-8 Encode OSD String Close\n");
    printf("q. Exit\n");
    printf("Please input your choice>>");
}

//int osd_display(int argc, char *argv[])
int osd_display(void)
{
    fiosd_win_t win;
    fiosd_palette_t palette;
    fiosd_string_t string;
    int index;
    int ret, i;
    //fiosd_transparent_t tmp_transparent;
    //fiosd_charmap_t tmp_charmap;
    int i_luminance, i_b_luminance;
    int i_cr, i_cb, i_b_cr, i_b_cb;
    //char tmp_string[64];
    //int _MAX_DISPLAY_LEN = 64;
    char key;
    //fiosd_font_info_t finfo;
    //char devicename[]="/dev/fosd1";
    char devicename[100];
    int j = 1;

    while (1) {
        listitem_1();
        if (scanf("%c", &key) == 0) {
            scanf("%*[\n]");
            getchar();
            continue;
        }
        switch (key) {
        case '1':
            for (i = 0; i <= 1; i++) {
                memset(devicename, 100, 0);
                sprintf(devicename, "/dev/fosd%d%d", i, j);
                printf("open %s\n", devicename);
                video_fd[i] = open(devicename, O_RDWR);
                if (video_fd[i] < 0) {
                    printf("fosd1 open fail!");
                    exit(1);
                }
                initial_font(i);
                printf("open device:%s successfully!\n", devicename);
                //foreground
                i_luminance = 120;
                i_cb = 128;
                i_cr = 128;
                //background
                i_b_luminance = 30;
                i_b_cb = 128;
                i_b_cr = 128;

                index = 0;
                ret = ioctl(video_fd[i], FIOSDS_OFF, &index);
                win.windex = index;
                //          win.x = 100;
                //          win.y = 110;

                win.x = 10;
                win.y = 50;

                win.hdim = 11;
                win.vdim = 1;

                sprintf(&string.string[0], "CH%d OK", i);

                win.hdim = strlen(&string.string[0]);
                /*
                   printf("CH:%d",i);
                   for (k=1 ; k<=8 ; k++) {
                   printf(" 0x%x",string.string[k]);
                   }
                 */
                printf("\n");
                //win.hdim = strlen(&string.string[0]);
                printf("show CH=%d,win.hdim(%d)\n", i, win.hdim);
                ret = ioctl(video_fd[i], FIOSDS_WIN, &win);
                if (ret < 0) {
                    printf("FIOSDS_WIN Fail!\n");
                    goto end;
                }
                palette.index = index;
                palette.y = i_luminance;
                palette.cb = i_cb;
                palette.cr = i_cr;
                ret = ioctl(video_fd[i], FIOSDS_PALTCOLOR, &palette);
                if (ret < 0) {
                    printf("FIOSDS_PALTCOLOR 0 Fail!");
                    goto end;
                }
                palette.index = 1;
                palette.y = i_b_luminance;
                palette.cb = i_b_cb;
                palette.cr = i_b_cr;
                ret = ioctl(video_fd[i], FIOSDS_PALTCOLOR, &palette);
                if (ret < 0) {
                    printf("FIOSDS_PALTCOLOR 1 Fail!");
                    goto end;
                }
                string.windex = index;
                string.start = 0;
                string.fg_color = 0;
                string.bg_color = 1;

                ret = ioctl(video_fd[i], FIOSDS_STRING, &string);
                if (ret < 0) {
                    printf("FIOSDS_STRING Fail!");
                    goto end;
                }

                ret = ioctl(video_fd[i], FIOSDS_ON, &index);
                if (ret < 0) {
                    printf("FIOSDS_ON Fail!");
                    goto end;
                }
            }
            break;
        case '2':
            index = 0;
            for (i = 0; i < 8; i++) {
                ret = ioctl(video_fd[index], FIOSDS_OFF, &index);
            }
            break;
        case '3':
            for (index = 0; index < 8; index++)
                close(video_fd[index]);

            goto end;
            break;

        case 'q':
        case 'Q':
            goto end;
            break;

        default:
            break;
        }                       // end of switch
    }                           //end of while
  end:
    return 0;
}
